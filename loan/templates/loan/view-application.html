{% extends 'core/base.html' %} {% block content %}

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-12 col-lg-10">
      <!-- Application Header Card -->
      <div class="card mb-4 shadow-sm border-0">
        <div class="card-header text-white bg-primary">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="h5 mb-0">
              <i class="fas fa-file-alt me-2"></i>
              Application #{{ application.reference_number }}
            </h2>
            <span
              class="badge bg-{% if application.status == application.LoanStatus.APPROVED %}success{% elif application.status == application.LoanStatus.REJECTED %}danger{% else %}info{% endif %}"
            >
              {{ application.get_status_display }}
            </span>
          </div>
        </div> 
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between">
            <div class="mb-3">
              <h5 class="text-primary">{{ application.loan.name }}</h5>
              <div class="text-muted small">
                <i class="fas fa-calendar-alt me-1"></i>
                Applied: {{ application.applied_date|date:"M d, Y" }}
              </div>
            </div>
            <div class="text-end">
              <h4 class="text-success mb-1">
                ${{ application.amount|floatformat:2 }}
              </h4>
              <div class="text-muted small">
                {{ application.loan.interest_rate }}% Interest â€¢ {{ application.loan.term_length }} months
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Application Details Tabs -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-0 pt-3">
          <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#details">
                <i class="fas fa-info-circle me-1"></i>Details
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#documents">
                <i class="fas fa-file-upload me-1"></i>Documents
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#timeline">
                <i class="fas fa-history me-1"></i>Timeline
              </a>
            </li>
            {% if application.status == 'approved' %}
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#repayment">
                <i class="fas fa-calendar-check me-1"></i>Repayment
              </a>
            </li>
            {% endif %}
          </ul>
        </div>
        <div class="card-body tab-content">
          <!-- Details Tab -->
          <div class="tab-pane fade show active" id="details">
            <div class="row">
              <div class="col-md-6">
                <h5 class="mb-3 border-bottom pb-2">Application Information</h5>
                <div class="mb-3">
                  <label class="fw-bold">Loan Type:</label>
                  <p>{{ application.loan.loan_type }}</p>
                </div>
                <div class="mb-3">
                  <label class="fw-bold">Purpose:</label>
                  <p>{{ application.purpose }}</p>
                </div>
                <div class="mb-3">
                    {% if payment.frequency %}
                    <label class="fw-bold">Payment Frequency:</label>
                    <p>{{ payment.frequency }}</p>
                    {% else %}
                    <p class="alert bg-primary ">No available Payment Frequency</p>
                    {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <h5 class="mb-3 border-bottom pb-2">Personal Information</h5>
                <div class="mb-3">
                  <label class="fw-bold">Applicant:</label>
                  {% with full_name=application.customer.profile.first_name|add:' '|add:application.customer.profile.last_name %}
                    <p>{{ full_name|default:user.username }}</p>
                  {% endwith %}
                </div>
                <div class="mb-3">
                  <label class="fw-bold">Contact:</label>
                  <p>
                    {{ application.customer.email }}<br />
                    {{ application.phone_number }}
                  </p>
                </div>
                <div class="mb-3">
                  <label class="fw-bold">Applied Date:</label>
                  <p>{{ application.applied_date|date:"M d, Y H:ia" }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Documents Tab -->
          <div class="tab-pane fade" id="documents">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                      <i class="fas fa-id-card fa-2x text-primary me-3"></i>
                      <h5 class="mb-0">ID Proof</h5>
                    </div>
                    {% if application.id_proof %}
                    <a
                      href="{{ application.id_proof.url }}"
                      target="_blank"
                      class="btn btn-sm btn-outline-primary me-2"
                    >
                      <i class="fas fa-eye me-1"></i>View
                    </a>
                    <a
                      href="{{ application.id_proof.url }}"
                      download
                      class="btn btn-sm btn-outline-secondary"
                    >
                      <i class="fas fa-download me-1"></i>Download
                    </a>
                    {% else %}
                    <div class="alert alert-warning mb-0">
                      <i class="fas fa-exclamation-circle me-1"></i>
                      No ID proof uploaded
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                      <i
                        class="fas fa-file-invoice-dollar fa-2x text-success me-3"
                      ></i>
                      <h5 class="mb-0">Income Proof</h5>
                    </div>
                    {% if application.income_proof %}
                    <a
                      href="{{ application.income_proof.url }}"
                      target="_blank"
                      class="btn btn-sm btn-outline-primary me-2"
                    >
                      <i class="fas fa-eye me-1"></i>View
                    </a>
                    <a
                      href="{{ application.income_proof.url }}"
                      download
                      class="btn btn-sm btn-outline-secondary"
                    >
                      <i class="fas fa-download me-1"></i>Download
                    </a>
                    {% else %}
                    <div class="alert alert-warning mb-0">
                      <i class="fas fa-exclamation-circle me-1"></i>
                      No income proof uploaded
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline Tab -->
          <div class="tab-pane fade" id="timeline">
            <div class="timeline">
              <div
                class="timeline-item {% if application.applied_date %}active{% endif %}"
              >
                <div class="timeline-point"></div>
                <div class="timeline-content">
                  <h6>Application Submitted</h6>
                  <small class="text-muted"
                    >{{ application.applied_date|date:"M d, Y H:i" }}</small
                  >
                  <p>Your application was successfully submitted</p>
                </div>
              </div>
              <div
                class="timeline-item {% if application.review_date %}active{% endif %}"
              >
                <div class="timeline-point"></div>
                <div class="timeline-content">
                  <h6>Under Review</h6>
                  {% if application.review_date %}
                  <small class="text-muted"
                    >{{ application.review_date|date:"M d, Y H:i" }}</small
                  >
                  <p>Your application is being reviewed by our team</p>
                  {% else %}
                  <p class="text-muted">Pending review</p>
                  {% endif %}
                </div>
              </div>
              <div
                class="timeline-item {% if application.status == 'approved' or application.status == 'rejected' %}active{% endif %}"
              >
                <div class="timeline-point"></div>
                <div class="timeline-content">
                  <h6>Decision</h6>
                  {% if application.status == 'approved' %}
                  <small class="text-muted"
                    >{{ application.approved_date|date:"M d, Y H:i" }}</small
                  >
                  <p class="text-success">
                    Your application has been approved!
                  </p>
                  {% elif application.status == 'rejected' %}
                  <small class="text-muted"
                    >{{ application.rejected_date|date:"M d, Y H:i" }}</small
                  >
                  <p class="text-danger">Your application has been rejected</p>
                  {% if application.rejection_reason %}
                  <div class="alert alert-light">
                    <strong>Reason:</strong> {{ application.rejection_reason }}
                  </div>
                  {% endif %} {% else %}
                  <p class="text-muted">Pending decision</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Repayment Tab (Only for approved applications) -->
          {% if application.status == 'approved' %}
          <div class="tab-pane fade" id="repayment">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Due Date</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for payment in application.repayment_schedule.all %}
                  <tr>
                    <td>{{ payment.due_date|date:"M d, Y" }}</td>
                    <td>${{ payment.amount|floatformat:2 }}</td>
                    <td>
                      <span
                        class="badge bg-{% if payment.status == 'paid' %}success{% else %}warning{% endif %}"
                      >
                        {{ payment.get_status_display }}
                      </span>
                    </td>
                    <td>
                      {% if payment.status == 'pending' %}
                      <a href="#" class="btn btn-sm btn-outline-primary"
                        >Make Payment</a
                      >
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4" class="text-center py-4">
                      <i class="fas fa-info-circle text-muted me-2"></i>
                      No repayment schedule available
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-between">
        <a
          href="{% url 'loan:my-applications' %}"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-arrow-left me-1"></i> Back to Applications
        </a>
        <div>
          {% if application.status == 'pending' %}
          <a href="#" class="btn btn-outline-danger me-2">Cancel Application</a>
          {% endif %} {% if application.status == 'approved' %}
          <a href="#" class="btn btn-primary">Accept Offer</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Timeline styling */
  .timeline {
    position: relative;
    padding-left: 1.5rem;
  }
  .timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
    border-left: 2px solid #dee2e6;
  }
  .timeline-item:last-child {
    border-left: 2px solid transparent;
  }
  .timeline-item.active {
    border-left-color: #0d6efd;
  }
  .timeline-point {
    position: absolute;
    left: -0.5rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: #dee2e6;
    top: 0.25rem;
  }
  .timeline-item.active .timeline-point {
    background: #0d6efd;
  }
  .timeline-content {
    padding-left: 1rem;
  }
</style>

{% endblock %}
